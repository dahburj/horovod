steps:
- label: ':docker: Build'
  plugins:
  - docker-compose#v2.6.0:
      build: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2
      image-repository: gcr.io/uber-ma/user/asergeev/buildkite

- wait

- label: ':docker: Run PyTests'
  command: bash -c "cd /horovod/test && (echo test_*.py | xargs -n 1 ${MPIRUN} pytest -v)"
  plugins:
  - docker-compose#v2.6.0:
      run: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2

- label: ':docker: Test TensorFlow MNIST'
  command: bash -c "$(cat /mpirun_command) python /horovod/examples/tensorflow_mnist.py"
  plugins:
  - docker-compose#v2.6.0:
      run: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2

- label: ':docker: Test TensorFlow Eager MNIST'
  command: bash -c "$(cat /mpirun_command) python /horovod/examples/tensorflow_mnist_eager.py"
  plugins:
  - docker-compose#v2.6.0:
      run: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2

- label: ':docker: Test Keras MNIST'
  command: bash -c "$(cat /mpirun_command) python /horovod/examples/keras_mnist_advanced.py"
  plugins:
  - docker-compose#v2.6.0:
      run: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2

- label: ':docker: Test PyTorch MNIST'
  command: bash -c "$(cat /mpirun_command) python /horovod/examples/pytorch_mnist.py"
  plugins:
  - docker-compose#v2.6.0:
      run: test-cpu-openmpi-py2_7-tf1_1_0-keras2_0_0-torch0_4_0-pyspark2_1_2

- wait

- label: ':hammer: nvidia-smi'
  plugins:
  - docker-compose#v2.6.0:
      run: nvidia-smi
